---
data_dir: /vector/data
api:
  enabled: true
  address: "0.0.0.0:8686"

sources:
  kubernetes:
    type: kubernetes_logs

  metrics:
    type: internal_metrics
    namespace: {{ .Sources.Metrics.Namespace }}
    scrape_interval_secs: 15

  logs:
    type: internal_logs

transforms:
{{- if .Transforms.Filter.Namespaces }}
  namespaces:
    type: filter
    inputs:
      - kubernetes
    condition: |-
      {{ range $index, $namespace := .Transforms.Filters.Namespaces }}
      .kubernetes.namespace_name = "{{ $namespace }}" ||
      {{- end }}
{{- end }}

{{- if ne .CRD.Transforms "" }}
  {{ .CRD.Transforms }}
{{- end }}

sinks:
  prometheus_exporter:
    type: prometheus_exporter
    inputs:
      - metrics
    address: 0.0.0.0:9100
    default_namespace: {{ .Sinks.Prometheus.Namespace }}

  logs:
    type: "console"
    inputs:
      - logs
    target: "stdout"
    encoding: "json"

{{ range $idx, $sink := .CRD.Sinks }}
  {{- if ne $sink.S3.Bucket "" }}
  s3:
    type: aws_s3
    inputs:
      {{ range $index, $input := $sink.S3.Inputs }}
      - {{ $input }}
      {{- end }}
    bucket: {{ $sink.S3.Bucket }}
    key_prefix: {{ $sink.S3.KeyPrefix }}
    compression: {{ $sink.S3.Compression }}
    encoding:
      codec: {{ $sink.S3.Encoding }}
    region: {{ $sink.S3.Region }}
    acl: {{ $sink.S3.ACL }}
    content_type: {{ $sink.S3.ContentType }}
    {{ if ne $sink.S3.Endpoint "" }}
    endpoint: {{ $sink.S3.Endpoint }}
    {{- end }}
  {{ else if ne $sink.Console.Target "" }}
  console:
    type: console
    inputs:
      {{ range $index, $input := $sink.Console.Inputs }}
      - {{ $input }}
      {{- end }}
    target: {{ $sink.Console.Target }}
    encoding:
      codec: {{ $sink.Console.Encoding }}
  {{ else if ne $sink.File.Path "" }}
  file:
    type: file
    inputs:
      {{ range $index, $input := $sink.File.Inputs }}
      - {{ $input }}
      {{- end }}
    compression: {{ $sink.File.Compression }}
    encoding:
      codec: {{ $sink.File.Encoding }}
    path: {{ $sink.File.Path }}
  {{ else if ne $sink.Elasticsearch.Endpoint "" }}
  elasticsearch:
    type: elasticsearch
    inputs:
      {{ range $index, $input := $sink.Elasticsearch.Inputs }}
      - {{ $input }}
      {{- end }}
    endpoint: {{ $sink.Elasticsearch.Endpoint }}
    pipeline: {{ $sink.Elasticsearch.Pipeline }}
    compression: {{ $sink.Elasticsearch.Compression }}
    encoding:
      codec: {{ $sink.Elasticsearch.Encoding }}
    mode: {{ $sink.Elasticsearch.Mode }}
    id_key: {{ $sink.Elasticsearch.IdKey }}
    {{- if ne $sink.Elasticsearch.Secret "" }}
    auth:
      user: ${ELASTIC_USERNAME}
      password: ${ELASTIC_PASSWORD}
    {{- end }}
    {{- if ne $sink.Elasticsearch.TLSCA "" }}
    tls:
      ca_file: {{ $sink.Elasticsearch.TLSCA }}
    {{- end }}
  {{ else if ne $sink.HTTP.URI "" }}
  http:
    type: http
    inputs:
      {{ range $index, $input := $sink.HTTP.Inputs }}
      - {{ $input }}
      {{- end }}
    uri: {{ $sink.HTTP.URI }}
    compression: {{ $sink.HTTP.Compression }}
    encoding:
      codec: {{ $sink.HTTP.encoding }}
    method: {{ $sink.HTTP.Method }}
    {{ if ne $sink.HTTP.Secret "" }}
    auth:
      user: ${HTTP_USERNAME}
      password: ${HTTP_PASSWORD}
    {{- end }}
  {{ else if ne $sink.Kafka.Topic "" }}
  kafka:
    type: kafka
    inputs:
      {{ range $index, $input := $sink.Kafka.Inputs }}
      - {{ $input }}
      {{- end }}
    bootstrap_servers: {{ $sink.Kafka.BootstrapServers }}
    key_field: {{ $sink.Kafka.KeyField }}
    topic: {{ $sink.Kafka.Topic }}
    compression: {{ $sink.Kafka.Compression }}
    encoding:
      codec: {{ $sink.Kafka.Encoding }}
    {{ if ne $sink.Kafka.Sasl.Secret "" }}
    sasl:
      enabled: true
      mechanism: {{ $sink.Kafka.Sasl.Mechanism }}
      username: ${KAFKA_USERNAME}
      password: ${KAFKA_PASSWORD}
    {{- end }}
  {{ else if ne $sink.Loki.Endpoint "" }}
  loki:
    type: loki
    inputs:
      {{ range $index, $input := $sink.Loki.Inputs }}
      - {{ $input }}
      {{- end }}
    endpoint: {{ $sink.Loki.Endpoint }}
    compression: {{ $sink.Loki.Compression }}
    encoding:
      codec: {{ $sink.Loki.Encoding }}
    labels:
      {{ range $key, $value := $sink.Loki.Labels }}
      {{ $key }}: {{ $value }}
      {{- end }}
    tenant_id: {{ $sink.Loki.TenantId }}
  {{ else if ne $sink.Vector.Address "" }}
  vector:
    type: vector
    inputs:
      {{ range $index, $input := $sink.Vector.Inputs }}
      - {{ $input }}
      {{- end }}
    address: {{ $sink.Vector.Address }}
    compression: {{ $sink.Vector.Compression }}
    version: {{ $sink.Vector.Version }}
  {{- end }}
{{- end }}